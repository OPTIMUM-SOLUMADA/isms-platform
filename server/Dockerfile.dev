FROM node:22-bullseye-slim

WORKDIR /app

# Install system dependencies first (LibreOffice, poppler, fonts)
RUN apt-get update && \
    apt-get install -y libreoffice poppler-utils fonts-liberation fonts-noto && \
    rm -rf /var/lib/apt/lists/*

# Copy package.json and Prisma schema first
COPY package*.json ./
COPY prisma ./prisma

# Install dependencies (postinstall will run prisma generate)
RUN npm install --legacy-peer-deps

RUN npx prisma generate

# Copy rest of source code
COPY . .

# Expose port
EXPOSE 8080

# Run dev server with hot reload
CMD ["npm", "run", "dev"]
